<section class="breadcrumb">
  <div class="container">
    <h2>Agent Towing Management</h2>
    <ul>
      <li><a routerLink="/">Home</a> ></li>
      <li>Agent Towing</li>
    </ul>
  </div>
</section>

<section class="contact-us">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <!-- Agents List -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Agents</h2>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <input type="text" class="form-control" placeholder="Search agent..." [(ngModel)]="searchText" (input)="filterAgents()">
            </div> 
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Contact Info</th>
                  <th>Availability</th>
                  <th>Vehicle Type</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let agent of filteredAgents  | paginate: { itemsPerPage: 3, currentPage: page } ">
                  <td>{{ agent.idAgent }}</td>
                  <td>{{ agent.name }}</td>
                  <td>{{ agent.contactInfo }}</td>
                  <td>{{ agent.availability ? 'Available' : 'Busy' }}</td>
                  <td>{{ agent.vehicleType }}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" (click)="editAgent(agent)">Edit</button>
                    <button class="btn btn-sm btn-danger" (click)="deleteAgent(agent.idAgent!)">Delete</button>
                  </td>
                </tr>
              </tbody>
            </table>
            <pagination-controls (pageChange)="page = $event"></pagination-controls>
          </div>
        </div>

        <!-- Create/Edit Agent -->
        <div *ngIf="!selectedAgent; else editForm">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h3 class="mb-0">Add Agent</h3>
            </div>
            <div class="card-body">
              <form [formGroup]="agentForm" (ngSubmit)="selectedAgent ? updateAgent() : createAgent()">
                <div class="form-group mb-3">
                  <label>Name:</label>
                  <input type="text" formControlName="name" class="form-control">
                  <div *ngIf="agentForm.controls['name'].invalid && agentForm.controls['name'].touched">
                    <small class="text-danger">Name must be 3-50 characters.</small>
                  </div>
                </div>

                <div class="form-group mb-3">
                  <label>Contact Info:</label>
                  <input type="text" formControlName="contactInfo" class="form-control">
                  <div *ngIf="agentForm.controls['contactInfo'].invalid && agentForm.controls['contactInfo'].touched">
                    <small class="text-danger">Enter a valid phone number.</small>
                  </div>
                </div>

                <div class="form-group mb-3">
                  <label>Availability:</label>
                  <select formControlName="availability" class="form-control">
                    <option [value]="true">Available</option>
                    <option [value]="false">Busy</option>
                  </select>
                </div>

                <div class="form-group mb-3">
                  <label>Vehicle Type:</label>
                  <input type="text" formControlName="vehicleType" class="form-control">
                  <div *ngIf="agentForm.controls['vehicleType'].invalid && agentForm.controls['vehicleType'].touched">
                    <small class="text-danger">Vehicle type is required.</small>
                  </div>
                </div>

                <button type="submit" class="btn btn-success mt-2" [disabled]="agentForm.invalid">
                  {{ selectedAgent ? 'Update' : 'Create' }}
                </button>
                <button *ngIf="selectedAgent" type="button" class="btn btn-secondary mt-2 ms-2" (click)="cancelEdit()">Cancel</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Edit Agent Form -->
        <ng-template #editForm>
          <div class="card">
            <div class="card-header bg-warning text-dark">
              <h3 class="mb-0">Edit Agent</h3>
            </div>
            <div class="card-body">
              <form [formGroup]="agentForm" (ngSubmit)="updateAgent()">
                <div class="form-group mb-3">
                  <label for="editName">Name:</label>
                  <input type="text" id="editName" class="form-control" formControlName="name" required>
                </div>

                <div class="form-group mb-3">
                  <label for="editContactInfo">Contact Info:</label>
                  <input type="text" id="editContactInfo" class="form-control" formControlName="contactInfo" required>
                </div>

                <div class="form-group mb-3">
                  <label for="editAvailability">Availability:</label>
                  <select id="editAvailability" class="form-control" formControlName="availability">
                    <option [value]="true">Available</option>
                    <option [value]="false">Busy</option>
                  </select>
                </div>

                <div class="form-group mb-3">
                  <label for="editVehicleType">Vehicle Type:</label>
                  <input type="text" id="editVehicleType" class="form-control" formControlName="vehicleType" required>
                </div>

                <button type="submit" class="btn btn-warning">Update</button>
                <button type="button" class="btn btn-secondary ms-2" (click)="cancelEdit()">Cancel</button>
              </form>
            </div>
          </div>
        </ng-template>

        <section class="map-section">
          <h3>Towing Requests Map</h3>
          <div id="map" style="height: 500px;"></div>
        </section>
      </div>
    </div>
  </div>
</section>
